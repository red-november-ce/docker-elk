# cisco.conf — парсер для логов Cisco
input {
  udp {
    port => 5140         
    type => "cisco"
  }
  tcp {
    port => 5140         
    type => "cisco"
  }
}

filter {
  if [type] == "cisco" {
    grok {
      match => { "message" => "^<%{POSINT:syslog_pri}>%{GREEDYDATA:cisco_message}" }
      tag_on_failure => [ "_grok_parse_failure_pri" ]
    }

    if [cisco_message] =~ /ASA-/ {
      mutate { add_tag => [ "cisco_asa" ] }
    } else if [cisco_message] =~ /%LINK-/ or [cisco_message] =~ /%SYS-/ {
      mutate { add_tag => [ "cisco_ios" ] }
    } else if [cisco_message] =~ /NX-OS/ {
      mutate { add_tag => [ "cisco_nxos" ] }
    }

 
    grok {
      match => [
        "cisco_message",
        "%{CISCOTIMESTAMP:timestamp} %{HOSTNAME:host} %{GREEDYDATA:log_message}",
        "%{CISCOTIMESTAMP:timestamp} %{IP:host} %{GREEDYDATA:log_message}",
        "%{CISCOTIMESTAMP:timestamp} %{DATA:host} %{GREEDYDATA:log_message}"
      ]
      tag_on_failure => [ "_grok_syslog_parse_failure" ]
    }

    
    if [timestamp] {
      date {
        match => [ "timestamp", "MMM dd HH:mm:ss", "MMM  d HH:mm:ss", "ISO8601" ]
        target => "@timestamp"
        remove_field => [ "timestamp" ]
      }
    }


    if "cisco_asa" in [tags] {
      # Пример: %ASA-4-106023: Deny tcp src outside:...
      grok {
        match => { "log_message" => "%{CISCOFW}" }
        tag_on_failure => []
      }
    }


    mutate {
      remove_field => [ "message", "cisco_message" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "cisco-logs-%{+YYYY.MM.dd}"
  }

}